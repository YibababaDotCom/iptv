name: Sync M3U to Root

on:
  schedule:
    - cron: '0 0 * * *'  # æ¯å¤©æ‰§è¡Œä¸€æ¬¡
  workflow_dispatch:     # æ‰‹åŠ¨è§¦å‘

permissions:
  contents: write

jobs:
  sync:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout your repo
        uses: actions/checkout@v4
        with:
          persist-credentials: false

      # ðŸ”½ ä»…ä¸‹è½½ä½ éœ€è¦çš„ç‰¹å®šæº 1
      - name: Download sports.m3u as Nowsports.m3u
        run: |
          echo "æ­£åœ¨ä¸‹è½½ sports.m3u å¹¶é‡å‘½å..."
          curl -L -o "Nowsports.m3u" "https://raw.githubusercontent.com/ediart/tvbox/refs/heads/main/TVBoxOSC/tvbox/sports.m3u"

      # ðŸ”½ ä»…ä¸‹è½½ä½ éœ€è¦çš„ç‰¹å®šæº 2
      - name: Download StarHub.m3u
        run: |
          echo "æ­£åœ¨ä¸‹è½½ StarHub.m3u..."
          curl -L -o "StarHub.m3u" "https://raw.githubusercontent.com/AbidUrsa/StarHubPlaylist/refs/heads/main/StarHub.m3u"

      # æäº¤å¹¶æŽ¨é€ä¿®æ”¹
      - name: Commit and Push if changed
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -e
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

          # ä»…æ·»åŠ å½“å‰ç›®å½•ä¸‹çš„ m3u/m3u8 æ–‡ä»¶
          git add *.m3u *.m3u8 2>/dev/null || true

          if git diff --cached --quiet; then
            echo "æ²¡æœ‰æ£€æµ‹åˆ°ä»»ä½•æ›´æ–°ã€‚"
            exit 0
          fi

          git commit -m "Update M3U playlists: Nowsports and StarHub"

          git remote set-url origin "https://x-access-token:${GITHUB_TOKEN}@github.com/${GITHUB_REPOSITORY}.git"
          git push origin HEAD:${GITHUB_REF#refs/heads/}
